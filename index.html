<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas G.G. (Gastos Compartidos)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo básico para la ventana modal */
        .modal {
            transition: opacity 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">

    <div id="notification-container" class="fixed top-0 inset-x-0 flex items-start justify-center p-4 z-50 pointer-events-none">
        </div>

    <nav class="sticky top-0 bg-white shadow-md z-10">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex justify-around h-16">
                <button data-tab="DIARIOS" class="tab-button border-b-2 border-transparent hover:border-blue-500 py-4 px-2 text-sm font-medium text-gray-500 active-tab">DIARIOS</button>
                <button data-tab="MENSUAL" class="tab-button border-b-2 border-transparent hover:border-blue-500 py-4 px-2 text-sm font-medium text-gray-500">MENSUAL</button>
                <button data-tab="SOLO JC" class="tab-button border-b-2 border-transparent hover:border-blue-500 py-4 px-2 text-sm font-medium text-gray-500">SOLO JC</button>
                <button data-tab="BALANCE" class="tab-button border-b-2 border-transparent hover:border-blue-500 py-4 px-2 text-sm font-medium text-gray-500">BALANCE</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-4xl mx-auto w-full p-4">
        
        <div id="tab-container">
            <div id="tab-DIARIOS" data-sheet-key="DAILY" class="tab-content">
                <h2 class="text-2xl font-bold mb-4">Registro de Gastos Diarios</h2>
                <form id="form-DIARIOS" class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="daily-concepto" class="block text-sm font-medium text-gray-700">Concepto</label>
                            <input type="text" id="daily-concepto" name="concepto" required list="daily-suggestions" autocomplete="off" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <datalist id="daily-suggestions"></datalist>
                        </div>
                        <div>
                            <label for="daily-monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                            <input type="number" step="0.01" id="daily-monto" name="monto" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="daily-pagador" class="block text-sm font-medium text-gray-700">Pagador</label>
                            <select id="daily-pagador" name="pagador" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </select>
                        </div>
                         <div>
                            <label for="daily-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="daily-fecha" name="fecha" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                     <div class="mb-4">
                        <label for="daily-observacion" class="block text-sm font-medium text-gray-700">Observación (Opcional)</label>
                        <input type="text" id="daily-observacion" name="observacion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">Registrar Gasto Diario</button>
                </form>

                <h3 class="text-xl font-semibold mb-3">Últimos Gastos Diarios</h3>
                <div id="daily-list" class="space-y-2">
                    </div>
            </div>

            <div id="tab-MENSUAL" data-sheet-key="MONTHLY" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Registro de Gastos Mensuales Fijos</h2>
                <form id="form-MENSUAL" class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="monthly-concepto" class="block text-sm font-medium text-gray-700">Concepto</label>
                            <input type="text" id="monthly-concepto" name="concepto" required list="monthly-suggestions" autocomplete="off" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <datalist id="monthly-suggestions"></datalist>
                        </div>
                        <div>
                            <label for="monthly-monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                            <input type="number" step="0.01" id="monthly-monto" name="monto" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="monthly-pagador" class="block text-sm font-medium text-gray-700">Pagador</label>
                            <select id="monthly-pagador" name="pagador" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                </select>
                        </div>
                        <div>
                            <label for="monthly-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="monthly-fecha" name="fecha" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                     <div class="mb-4">
                        <label for="monthly-observacion" class="block text-sm font-medium text-gray-700">Observación (Opcional)</label>
                        <input type="text" id="monthly-observacion" name="observacion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">Registrar Gasto Mensual</button>
                </form>

                <h3 class="text-xl font-semibold mb-3">Gastos Mensuales Fijos</h3>
                <div id="monthly-list" class="space-y-2">
                    </div>
            </div>
            
            <div id="tab-SOLO JC" data-sheet-key="JC_ONLY" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Registro de Gastos Solo Juan C.</h2>
                <form id="form-SOLO JC" class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="jc-concepto" class="block text-sm font-medium text-gray-700">Concepto</label>
                            <input type="text" id="jc-concepto" name="concepto" required list="jc-suggestions" autocomplete="off" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <datalist id="jc-suggestions"></datalist>
                        </div>
                        <div>
                            <label for="jc-monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                            <input type="number" step="0.01" id="jc-monto" name="monto" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Pagador</label>
                            <p class="mt-1 block w-full border border-gray-300 bg-gray-200 rounded-md shadow-sm p-2">Juan</p>
                            <input type="hidden" name="pagador" value="Juan">
                        </div>
                        <div>
                            <label for="jc-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="jc-fecha" name="fecha" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="jc-observacion" class="block text-sm font-medium text-gray-700">Observación (Opcional)</label>
                        <input type="text" id="jc-observacion" name="observacion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">Registrar Gasto Juan C.</button>
                </form>

                <h3 class="text-xl font-semibold mb-3">Gastos Personales Juan C.</h3>
                <div id="jcOnly-list" class="space-y-2">
                    </div>
            </div>

            <div id="tab-BALANCE" data-sheet-key="BALANCE" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-4">Balance General</h2>
                <div id="balance-view" class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <div id="balance-loading" class="text-center text-gray-500">Cargando balance...</div>
                </div>
                
                <h3 class="text-xl font-semibold mb-3">Desglose de Gastos Comunes (En desarrollo)</h3>
                <div id="desglose-view" class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-500">El reporte de desglose de gastos comunes estará disponible pronto.</p>
                </div>
            </div>

        </div>
    </main>
    
    <div id="edit-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto p-6">
            <h3 class="text-xl font-bold mb-4">Editar Gasto</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id" name="id">
                <input type="hidden" id="edit-sheet-key" name="sheetKey">
                
                <div class="mb-4">
                    <label for="edit-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="edit-fecha" name="fecha" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="mb-4">
                    <label for="edit-concepto" class="block text-sm font-medium text-gray-700">Concepto</label>
                    <input type="text" id="edit-concepto" name="concepto" required list="edit-suggestions" autocomplete="off" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <datalist id="edit-suggestions"></datalist>
                </div>
                <div class="mb-4">
                    <label for="edit-monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                    <input type="number" step="0.01" id="edit-monto" name="monto" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="mb-4">
                    <label for="edit-pagador" class="block text-sm font-medium text-gray-700">Pagador</label>
                    <select id="edit-pagador" name="pagador" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </select>
                </div>
                <div class="mb-4">
                    <label for="edit-observacion" class="block text-sm font-medium text-gray-700">Observación (Opcional)</label>
                    <input type="text" id="edit-observacion" name="observacion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="close-modal-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 ease-in-out">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ====================================================================
        // === CONFIGURACIÓN GLOBAL ===========================================
        // ====================================================================

        // !! LA NUEVA URL DE GOOGLE APPS SCRIPT !!
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxrqnXPqCLxXoOZ2TeejK5zV9u_kmKgvVHJSmnE1eEuEizwvV3azrXaSnXLBrlc7mm5/exec";
        
        // Pagadores (Lista fija)
        const PAYERS = ['Juan', 'Tania'];
        
        // Mapeo de Tab a Clave de Hoja (Sheet Key)
        const SHEET_KEYS = {
            'DIARIOS': 'DAILY',
            'MENSUAL': 'MONTHLY',
            'SOLO JC': 'JC_ONLY'
        };

        // ====================================================================
        // === ESTADO DE LA APLICACIÓN ========================================
        // ====================================================================

        const state = {
            activeTab: 'DIARIOS',
            daily: [],
            monthly: [],
            jcOnly: [],
            balance: { juan: 0, tania: 0 },
            // AHORA LAS CATEGORÍAS VIENEN DE GOOGLE SHEETS
            categories: { DAILY: [], MONTHLY: [], JC_ONLY: [] },
            isSubmitting: false,
        };
        
        // ====================================================================
        // === UTILIDADES =====================================================
        // ====================================================================

        /**
         * Formatea un número como moneda local (Uruguay, asumiendo USD/UYU).
         * @param {number} amount
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-UY', { style: 'currency', currency: 'USD' }).format(amount);
        };

        /**
         * Formatea la fecha en el formato AAAA-MM-DD para inputs tipo 'date'.
         * @param {Date | string} date
         */
        const formatDateForInput = (date) => {
            if (!date) return '';
            const d = new Date(date);
            // Si la fecha de la hoja es solo AAAA-MM-DD, se necesita ajustar para evitar problemas de zona horaria
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        /**
         * Muestra una notificación temporal.
         * @param {string} message 
         * @param {'success' | 'error' | 'info'} type 
         */
        const showNotification = (message, type = 'info') => {
            const container = document.getElementById('notification-container');
            const colorClasses = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const element = document.createElement('div');
            element.className = `${colorClasses[type]} text-white px-6 py-3 rounded-lg shadow-lg pointer-events-auto`;
            element.textContent = message;

            // Limpiar notificaciones previas
            container.innerHTML = '';
            container.appendChild(element);

            // Ocultar después de 4 segundos
            setTimeout(() => {
                element.remove();
            }, 4000);
        };

        // ====================================================================
        // === GESTIÓN DE PISTAS DE DATOS (Autocomplete) ======================
        // ====================================================================

        /**
         * Configura las sugerencias de autocompletado para el campo Concepto.
         * @param {string} tabId El ID de la pestaña (ej: 'DIARIOS', 'MENSUAL').
         */
        const setupAutocomplete = (tabId) => {
            const sheetKey = SHEET_KEYS[tabId];
            const datalistId = `${tabId.toLowerCase()}-suggestions`;
            const datalist = document.getElementById(datalistId);
            
            if (!datalist) return;
            
            datalist.innerHTML = '';

            // Usa las categorías cargadas desde Google Sheets
            const concepts = state.categories[sheetKey] || []; 
            
            concepts.forEach(concept => {
                const option = document.createElement('option');
                option.value = concept;
                datalist.appendChild(option);
            });
            
            // Si está abierto el modal, también actualiza las sugerencias del modal
             if (tabId === document.getElementById('edit-sheet-key').value) {
                const editDatalist = document.getElementById('edit-suggestions');
                 editDatalist.innerHTML = datalist.innerHTML;
            }
        };

        // ====================================================================
        // === RENDERIZADO DE LA VISTA ========================================
        // ====================================================================
        
        /**
         * Rellena los selects de Pagador en los formularios.
         */
        const fillPayerSelects = () => {
            document.querySelectorAll('select[name="pagador"]').forEach(select => {
                const selectedValue = select.value; // Guardar valor seleccionado si existe
                select.innerHTML = ''; // Limpiar opciones
                
                // Opción por defecto (deshabilitada)
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Selecciona Pagador";
                defaultOption.disabled = true;
                select.appendChild(defaultOption);
                
                PAYERS.forEach(payer => {
                    const option = document.createElement('option');
                    option.value = payer;
                    option.textContent = payer;
                    if (payer === selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Asegurar que haya una opción seleccionada (si se cargó con un valor)
                if (!selectedValue) {
                    select.selectedIndex = 0; 
                }
            });
        };


        /**
         * Renderiza un gasto individual.
         * @param {Object} item El objeto de gasto.
         * @param {string} sheetKey Clave de la hoja (DAILY, MONTHLY, JC_ONLY).
         */
        const renderListItem = (item, sheetKey) => {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${item.Concepto} (${formatDateForInput(item.Fecha)})</p>
                    <p class="text-sm text-gray-600">${item.Pagador} pagó ${formatCurrency(item.Monto)}</p>
                    ${item.Observación ? `<p class="text-xs text-gray-400">Obs: ${item.Observación}</p>` : ''}
                </div>
                <div class="space-x-2">
                    <button data-id="${item.ID}" data-key="${sheetKey}" class="edit-btn text-blue-500 hover:text-blue-700 text-sm">Editar</button>
                    <button data-id="${item.ID}" data-key="${sheetKey}" class="delete-btn text-red-500 hover:text-red-700 text-sm">Eliminar</button>
                </div>
            `;
            return div;
        };

        /**
         * Renderiza todas las listas de gastos.
         */
        const renderLists = () => {
            const lists = {
                DAILY: document.getElementById('daily-list'),
                MONTHLY: document.getElementById('monthly-list'),
                JC_ONLY: document.getElementById('jcOnly-list')
            };

            // Asegurar que las listas estén vacías
            lists.DAILY.innerHTML = '';
            lists.MONTHLY.innerHTML = '';
            lists.JC_ONLY.innerHTML = '';

            // Renderizar DIARIOS
            state.daily
                .slice().sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha)) // Ordenar por fecha descendente
                .slice(0, 10) // Mostrar solo los 10 más recientes
                .forEach(item => lists.DAILY.appendChild(renderListItem(item, 'DAILY')));

            // Renderizar MENSUALES
            state.monthly
                .slice().sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha))
                .forEach(item => lists.MONTHLY.appendChild(renderListItem(item, 'MONTHLY')));
                
            // Renderizar SOLO JC
            state.jcOnly
                .slice().sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha))
                .forEach(item => lists.JC_ONLY.appendChild(renderListItem(item, 'JC_ONLY')));
                
            // Configurar autocompletado para la pestaña activa
            setupAutocomplete(state.activeTab); 
        };
        
        /**
         * Actualiza la vista del balance.
         */
        const updateBalanceView = () => {
            const view = document.getElementById('balance-view');
            
            // Eliminar mensaje de carga
            const loading = document.getElementById('balance-loading');
            if(loading) loading.remove();
            
            const { juan, tania } = state.balance;
            let message = '';
            let color = '';

            if (juan === 0 && tania === 0) {
                message = "¡El balance está en cero! No hay deudas pendientes.";
                color = 'text-green-600';
            } else if (juan < 0) {
                // Juan debe a Tania (Juan tiene saldo negativo)
                message = `Juan debe ${formatCurrency(Math.abs(juan))} a Tania.`;
                color = 'text-red-600';
            } else if (tania < 0) {
                 // Tania debe a Juan (Tania tiene saldo negativo)
                message = `Tania debe ${formatCurrency(Math.abs(tania))} a Juan.`;
                color = 'text-red-600';
            } else if (juan > 0 && tania === 0) {
                 // El balance solo se calcula por diferencia, si uno está en 0 y el otro no,
                 // es una situación menos común que podría requerir revisión, pero se informa.
                 message = `Saldo: Juan tiene ${formatCurrency(juan)} a favor, Tania 0.`;
                 color = 'text-yellow-600';
            } else if (tania > 0 && juan === 0) {
                 message = `Saldo: Tania tiene ${formatCurrency(tania)} a favor, Juan 0.`;
                 color = 'text-yellow-600';
            }
            
            view.innerHTML = `
                <div class="text-center">
                    <p class="text-xl font-bold mb-2 ${color}">${message}</p>
                    <p class="text-md text-gray-700">Saldo de Juan: ${formatCurrency(juan)}</p>
                    <p class="text-md text-gray-700">Saldo de Tania: ${formatCurrency(tania)}</p>
                    <p class="mt-4 text-sm text-gray-500">Nota: El saldo reflejado es el valor en la hoja de cálculo BALANCE.</p>
                </div>
            `;
        };
        
        // ====================================================================
        // === GESTIÓN DE PESTAÑAS (Tabs) =====================================
        // ====================================================================

        /**
         * Cambia la pestaña activa.
         * @param {string} tabId El ID de la pestaña a activar.
         */
        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active-tab', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeContent = document.getElementById(`tab-${tabId}`);
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            if (activeButton) {
                activeButton.classList.add('active-tab', 'border-blue-500', 'text-blue-600');
                activeButton.classList.remove('border-transparent', 'text-gray-500');
            }

            state.activeTab = tabId;
            
            // Si la pestaña no es BALANCE, se configura el autocompletado
            if (tabId !== 'BALANCE') {
                 setupAutocomplete(tabId);
            } else {
                // Si es BALANCE, aseguramos que la vista esté actualizada
                updateBalanceView();
            }
        };

        // ====================================================================
        // === COMUNICACIÓN CON GOOGLE APPS SCRIPT (GAS) ======================
        // ====================================================================
        
        /**
         * Envía una petición POST al Apps Script.
         * @param {Object} payload Los datos a enviar (action, sheetKey, data).
         */
        const sendRequest = async (payload) => {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors', // Necesario para evitar problemas de CORS
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data;

            } catch (error) {
                showNotification(`Error de petición: ${error.message}`, 'error');
                console.error("Error en sendRequest:", error);
                throw error; 
            }
        };


        /**
         * Carga los datos iniciales (gastos y categorías) desde Google Sheets.
         */
        const loadInitialData = async () => {
            try {
                const response = await fetch(GAS_URL, { method: 'GET', mode: 'cors' });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // 1. ASIGNAR LAS CATEGORÍAS DESDE GOOGLE SHEETS
                if (data.CATEGORIES_FROM_SHEETS) {
                    state.categories = data.CATEGORIES_FROM_SHEETS; 
                } else {
                    // Fallback si el campo viene vacío (aunque el GAS ya tiene un fallback)
                    state.categories = { DAILY: [], MONTHLY: [], JC_ONLY: [] };
                }
                
                // 2. ASIGNAR LOS DATOS DE GASTOS
                state.daily = data.daily || [];
                state.monthly = data.monthly || [];
                state.jcOnly = data.jcOnly || [];
                
                // 3. ASIGNAR EL BALANCE
                state.balance = data.balance || { juan: 0, tania: 0 };
                
                // 4. RENDERIZAR TODO
                fillPayerSelects(); 
                renderLists();
                updateBalanceView();
                switchTab(state.activeTab); // Asegurar que la pestaña activa se muestre correctamente

                showNotification('Datos sincronizados correctamente.', 'success');

            } catch (error) {
                 showNotification('Error al cargar datos iniciales. Revisa la URL y el Apps Script.', 'error');
                 console.error("Error en loadInitialData:", error);
            }
        };
        
        // ====================================================================
        // === GESTIÓN DE FORMULARIOS =========================================
        // ====================================================================
        
        /**
         * Valida que el concepto usado exista en la lista de conceptos permitidos.
         * @param {string} concept El concepto introducido por el usuario.
         * @param {string} sheetKey La clave de la hoja (DAILY, MONTHLY, JC_ONLY).
         */
        const validateConcept = (concept, sheetKey) => {
            const list = state.categories[sheetKey];
            if (!list || list.length === 0) {
                 // Si no hay lista de categorías (ej. error de carga), lo permitimos para no bloquear
                return true; 
            }
            // Forzamos mayúsculas para la comparación estricta
            const upperConcept = concept.toUpperCase().trim();
            return list.includes(upperConcept);
        };

        /**
         * Maneja el envío de formularios de registro.
         * @param {Event} event 
         * @param {string} sheetKey 
         */
        const handleRegister = async (event, sheetKey) => {
            event.preventDefault();

            if (state.isSubmitting) return;
            state.isSubmitting = true;

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Paso de Validación Estricta
            if (!validateConcept(data.concepto, sheetKey)) {
                showNotification(`Error: El concepto '${data.concepto.toUpperCase()}' no es un concepto válido para esta hoja. Debe elegir uno de la lista.`, 'error');
                state.isSubmitting = false;
                return;
            }

            try {
                const payload = {
                    action: 'REGISTER',
                    sheetKey: sheetKey,
                    data: {
                        ...data,
                        // Aseguramos que el concepto esté en mayúsculas para el GAS
                        concepto: data.concepto.toUpperCase(),
                        monto: parseFloat(data.monto)
                    }
                };

                await sendRequest(payload);
                showNotification('Gasto registrado con éxito. Recargando datos...', 'success');
                form.reset();
                await loadInitialData(); // Recargar datos para ver el cambio y actualizar balance
            } catch (error) {
                // Error ya manejado en sendRequest
            } finally {
                state.isSubmitting = false;
            }
        };
        
        /**
         * Maneja el envío del formulario de edición.
         */
        const handleEdit = async (event) => {
            event.preventDefault();

            if (state.isSubmitting) return;
            state.isSubmitting = true;
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            const sheetKey = data.sheetKey;
            
            // Paso de Validación Estricta para Edición
            if (!validateConcept(data.concepto, sheetKey)) {
                showNotification(`Error: El concepto '${data.concepto.toUpperCase()}' no es un concepto válido para esta hoja. Debe elegir uno de la lista.`, 'error');
                state.isSubmitting = false;
                return;
            }

            try {
                const payload = {
                    action: 'EDIT',
                    sheetKey: sheetKey,
                    data: {
                        ...data,
                        // Aseguramos que el concepto esté en mayúsculas
                        concepto: data.concepto.toUpperCase(),
                        monto: parseFloat(data.monto)
                    }
                };
                
                await sendRequest(payload);
                showNotification('Gasto actualizado con éxito. Recargando datos...', 'success');
                closeEditModal();
                await loadInitialData();
            } catch (error) {
                // Error ya manejado en sendRequest
            } finally {
                state.isSubmitting = false;
            }
        };

        /**
         * Maneja la eliminación de un gasto.
         * @param {string} id El ID del gasto.
         * @param {string} sheetKey Clave de la hoja.
         */
        const handleDelete = async (id, sheetKey) => {
            if (!confirm('¿Estás seguro de que quieres eliminar este gasto? Esta acción es irreversible.')) {
                return;
            }
            
            if (state.isSubmitting) return;
            state.isSubmitting = true;

            try {
                const payload = {
                    action: 'DELETE',
                    sheetKey: sheetKey,
                    data: { id: id }
                };

                await sendRequest(payload);
                showNotification('Gasto eliminado con éxito. Recargando datos...', 'success');
                await loadInitialData();
            } catch (error) {
                // Error ya manejado en sendRequest
            } finally {
                state.isSubmitting = false;
            }
        };
        
        // ====================================================================
        // === GESTIÓN DEL MODAL DE EDICIÓN ====================================
        // ====================================================================

        /**
         * Abre la ventana modal de edición y precarga los datos.
         * @param {string} id El ID del gasto.
         * @param {string} sheetKey Clave de la hoja (DAILY, MONTHLY, JC_ONLY).
         */
        const openEditModal = (id, sheetKey) => {
            const modal = document.getElementById('edit-modal');
            const dataArray = state[sheetKey.toLowerCase()];
            
            // Encontrar el gasto por ID
            const item = dataArray.find(i => String(i.ID) === id);

            if (!item) {
                showNotification('Error: Gasto no encontrado para edición.', 'error');
                return;
            }
            
            // 1. Precargar Sugerencias
            const currentTabId = Object.keys(SHEET_KEYS).find(key => SHEET_KEYS[key] === sheetKey);
            if (currentTabId) {
                // Llama al setup para llenar las sugerencias del modal con las categorías de la hoja correcta
                setupAutocomplete(currentTabId); 
            }

            // 2. Precargar el Formulario
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-sheet-key').value = sheetKey;
            document.getElementById('edit-fecha').value = formatDateForInput(item.Fecha);
            document.getElementById('edit-concepto').value = item.Concepto;
            document.getElementById('edit-monto').value = item.Monto;
            document.getElementById('edit-pagador').value = item.Pagador;
            document.getElementById('edit-observacion').value = item.Observación || '';
            
            // 3. Mostrar Modal
            modal.classList.remove('hidden');
        };
        
        /**
         * Cierra la ventana modal de edición.
         */
        const closeEditModal = () => {
            document.getElementById('edit-modal').classList.add('hidden');
        };
        
        // ====================================================================
        // === INICIALIZACIÓN Y EVENT LISTENERS ===============================
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // Inicialización de la aplicación
            loadInitialData();
            
            // Asignar la fecha de hoy a todos los campos de fecha
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
            
            // 1. Manejo de Pestañas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });

            // 2. Manejo de Formularios de Registro
            document.getElementById('form-DIARIOS').addEventListener('submit', (e) => handleRegister(e, 'DAILY'));
            document.getElementById('form-MENSUAL').addEventListener('submit', (e) => handleRegister(e, 'MONTHLY'));
            document.getElementById('form-SOLO JC').addEventListener('submit', (e) => handleRegister(e, 'JC_ONLY'));
            
            // 3. Manejo de Edición/Eliminación (Delegación de Eventos)
            document.getElementById('tab-container').addEventListener('click', (e) => {
                const target = e.target;
                const id = target.dataset.id;
                const key = target.dataset.key;

                if (target.classList.contains('edit-btn') && id && key) {
                    openEditModal(id, key);
                } else if (target.classList.contains('delete-btn') && id && key) {
                    handleDelete(id, key);
                }
            });
            
            // 4. Manejo del Modal de Edición
            document.getElementById('close-modal-btn').addEventListener('click', closeEditModal);
            document.getElementById('edit-form').addEventListener('submit', handleEdit);
            
            // Cierre del modal con ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape" && !document.getElementById('edit-modal').classList.contains('hidden')) {
                    closeEditModal();
                }
            });
        });

    </script>
</body>
</html>
